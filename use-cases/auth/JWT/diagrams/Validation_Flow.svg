<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="SEQUENCE" height="772px" preserveAspectRatio="none" style="width:1350px;height:772px;background:#FFFFFF;" version="1.1" viewBox="0 0 1350 772" width="1350px" zoomAndPan="magnify"><title>Secure request flow: "orgId from JWT, never from body"</title><defs/><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="402.0283" x="475.9233" y="28.5352">Secure request flow: "orgId from JWT, never from body"</text><g><title>Client</title><rect fill="#000000" fill-opacity="0.00000" height="556.5215" width="8" x="23.7524" y="121.4648"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="27" x2="27" y1="121.4648" y2="677.9863"/></g><g><title>API Gateway . Fastify</title><rect fill="#000000" fill-opacity="0.00000" height="556.5215" width="8" x="227.9307" y="121.4648"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="231.4814" x2="231.4814" y1="121.4648" y2="677.9863"/></g><g><title>Auth Middleware</title><rect fill="#000000" fill-opacity="0.00000" height="556.5215" width="8" x="494.792" y="121.4648"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="498.6299" x2="498.6299" y1="121.4648" y2="677.9863"/></g><g><title>Route Validator</title><rect fill="#000000" fill-opacity="0.00000" height="556.5215" width="8" x="640.3726" y="121.4648"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="644.0264" x2="644.0264" y1="121.4648" y2="677.9863"/></g><g><title>Handler</title><rect fill="#000000" fill-opacity="0.00000" height="556.5215" width="8" x="775.2617" y="121.4648"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="778.7188" x2="778.7188" y1="121.4648" y2="677.9863"/></g><g><title>Repository</title><rect fill="#000000" fill-opacity="0.00000" height="556.5215" width="8" x="1034.6519" y="121.4648"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="1037.8032" x2="1037.8032" y1="121.4648" y2="677.9863"/></g><g><title>DB</title><rect fill="#000000" fill-opacity="0.00000" height="556.5215" width="8" x="1295.3687" y="121.4648"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5,5;" x1="1298.8623" x2="1298.8623" y1="121.4648" y2="677.9863"/></g><g class="participant participant-head" data-participant="Client"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="39.5049" x="5" y="118.5117">Client</text><ellipse cx="27.7524" cy="53.4766" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M27.7524,61.4766 L27.7524,88.4766 M14.7524,69.4766 L40.7524,69.4766 M27.7524,88.4766 L14.7524,103.4766 M27.7524,88.4766 L40.7524,103.4766" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g class="participant participant-tail" data-participant="Client"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="39.5049" x="5" y="690.5215">Client</text><ellipse cx="27.7524" cy="701.9746" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M27.7524,709.9746 L27.7524,736.9746 M14.7524,717.9746 L40.7524,717.9746 M27.7524,736.9746 L14.7524,751.9746 M27.7524,736.9746 L40.7524,751.9746" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g class="participant participant-head" data-participant="GW"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="156.8984" x="153.4814" y="89.9766"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="142.8984" x="160.4814" y="110.5117">API Gateway / Fastify</text></g><g class="participant participant-tail" data-participant="GW"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="156.8984" x="153.4814" y="676.9863"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="142.8984" x="160.4814" y="697.5215">API Gateway / Fastify</text></g><g class="participant participant-head" data-participant="AM"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="128.3242" x="434.6299" y="89.9766"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="114.3242" x="441.6299" y="110.5117">Auth Middleware</text></g><g class="participant participant-tail" data-participant="AM"><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="128.3242" x="434.6299" y="676.9863"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="114.3242" x="441.6299" y="697.5215">Auth Middleware</text></g><g class="participant participant-head" data-participant="VAL"><rect fill="#E2E2F0" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="118.6924" x="585.0264" y="73.4883"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="104.6924" x="592.0264" y="94.0234">Route Validator</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="99.9277" x="594.4087" y="110.5117">(Zod/OpenAPI)</text></g><g class="participant participant-tail" data-participant="VAL"><rect fill="#E2E2F0" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="118.6924" x="585.0264" y="676.9863"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="104.6924" x="592.0264" y="697.5215">Route Validator</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="99.9277" x="594.4087" y="714.0098">(Zod/OpenAPI)</text></g><g class="participant participant-head" data-participant="H"><rect fill="#E2E2F0" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="131.0859" x="713.7188" y="73.4883"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="53.0947" x="752.7144" y="94.0234">Handler</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="117.0859" x="720.7188" y="110.5117">(marketHandlers)</text></g><g class="participant participant-tail" data-participant="H"><rect fill="#E2E2F0" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="131.0859" x="713.7188" y="676.9863"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="53.0947" x="752.7144" y="697.5215">Handler</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="117.0859" x="720.7188" y="714.0098">(marketHandlers)</text></g><g class="participant participant-head" data-participant="REPO"><rect fill="#E2E2F0" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="91.6973" x="992.8032" y="73.4883"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="72.126" x="1002.5889" y="94.0234">Repository</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="77.6973" x="999.8032" y="110.5117">(ports only)</text></g><g class="participant participant-tail" data-participant="REPO"><rect fill="#E2E2F0" height="46.9766" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="91.6973" x="992.8032" y="676.9863"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="72.126" x="1002.5889" y="697.5215">Repository</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="77.6973" x="999.8032" y="714.0098">(ports only)</text></g><g class="participant participant-head" data-participant="DB"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="18.5391" x="1287.0991" y="102.0234">DB</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="95.0127" x="1248.8623" y="118.5117">(RLS on orgId)</text><path d="M1281.3687,52.4883 C1281.3687,42.4883 1299.3687,42.4883 1299.3687,42.4883 C1299.3687,42.4883 1317.3687,42.4883 1317.3687,52.4883 L1317.3687,78.4883 C1317.3687,88.4883 1299.3687,88.4883 1299.3687,88.4883 C1299.3687,88.4883 1281.3687,88.4883 1281.3687,78.4883 L1281.3687,52.4883" fill="#E2E2F0" style="stroke:#181818;stroke-width:0.5;"/><path d="M1281.3687,52.4883 C1281.3687,62.4883 1299.3687,62.4883 1299.3687,62.4883 C1299.3687,62.4883 1317.3687,62.4883 1317.3687,52.4883" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g class="participant participant-tail" data-participant="DB"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="18.5391" x="1287.0991" y="690.5215">DB</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="95.0127" x="1248.8623" y="707.0098">(RLS on orgId)</text><path d="M1281.3687,719.9629 C1281.3687,709.9629 1299.3687,709.9629 1299.3687,709.9629 C1299.3687,709.9629 1317.3687,709.9629 1317.3687,719.9629 L1317.3687,745.9629 C1317.3687,755.9629 1299.3687,755.9629 1299.3687,755.9629 C1299.3687,755.9629 1281.3687,755.9629 1281.3687,745.9629 L1281.3687,719.9629" fill="#E2E2F0" style="stroke:#181818;stroke-width:0.5;"/><path d="M1281.3687,719.9629 C1281.3687,729.9629 1299.3687,729.9629 1299.3687,729.9629 C1299.3687,729.9629 1317.3687,729.9629 1317.3687,719.9629" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g class="message" data-participant-1="Client" data-participant-2="GW"><polygon fill="#181818" points="219.9307,179.3965,229.9307,183.3965,219.9307,187.3965,223.9307,183.3965" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="27.7524" x2="225.9307" y1="183.3965" y2="183.3965"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="177.8677" x="34.7524" y="148.0332">POST /orgs/{orgId}/markets</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="161.8398" x="34.7524" y="163.3438">Authorization: Bearer JWT</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="180.1782" x="34.7524" y="178.6543">Body: {symbol, quoteCcy, ...}</text></g><g class="message" data-participant-1="GW" data-participant-2="AM"><polygon fill="#181818" points="486.792,208.707,496.792,212.707,486.792,216.707,490.792,212.707" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="231.9307" x2="492.792" y1="212.707" y2="212.707"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="123.3096" x="238.9307" y="207.9648">Extract &amp; verify JWT</text></g><g class="message" data-participant-1="AM" data-participant-2="AM"><line style="stroke:#181818;stroke-width:1;" x1="498.792" x2="540.792" y1="272.6387" y2="272.6387"/><line style="stroke:#181818;stroke-width:1;" x1="540.792" x2="540.792" y1="272.6387" y2="285.6387"/><line style="stroke:#181818;stroke-width:1;" x1="499.792" x2="540.792" y1="285.6387" y2="285.6387"/><polygon fill="#181818" points="509.792,281.6387,499.792,285.6387,509.792,289.6387,505.792,285.6387" style="stroke:#181818;stroke-width:1;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99.7344" x="505.792" y="237.2754">Verify signature</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="124.1665" x="505.792" y="252.5859">Check exp/nbf/aud</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131.5806" x="505.792" y="267.8965">Check revocation list</text></g><g class="message" data-participant-1="AM" data-participant-2="GW"><polygon fill="#181818" points="242.9307,310.9492,232.9307,314.9492,242.9307,318.9492,238.9307,314.9492" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="236.9307" x2="497.792" y1="314.9492" y2="314.9492"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="242.8613" x="248.9307" y="310.207">Claims {userId, orgId=ORG_JWT, roles}</text></g><g class="message" data-participant-1="GW" data-participant-2="VAL"><polygon fill="#181818" points="632.3726,355.5703,642.3726,359.5703,632.3726,363.5703,636.3726,359.5703" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="231.9307" x2="638.3726" y1="359.5703" y2="359.5703"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="228.7632" x="238.9307" y="339.5176">Parse body with ZCreateMarketInput</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191.3638" x="238.9307" y="354.8281">(&#10060; orgId not allowed in body)</text></g><g class="message" data-participant-1="VAL" data-participant-2="GW"><polygon fill="#181818" points="242.9307,384.8809,232.9307,388.8809,242.9307,392.8809,238.9307,388.8809" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="236.9307" x2="643.3726" y1="388.8809" y2="388.8809"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="192.0166" x="248.9307" y="384.1387">Validated data or 422 on error</text></g><g class="message" data-participant-1="GW" data-participant-2="H"><polygon fill="#181818" points="767.2617,414.1914,777.2617,418.1914,767.2617,422.1914,771.2617,418.1914" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="231.9307" x2="773.2617" y1="418.1914" y2="418.1914"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="264.2148" x="238.9307" y="413.4492">createMarket(repo, orgId=ORG_JWT, data)</text></g><path d="M784,431.1914 L784,486.1914 L1004,486.1914 L1004,441.1914 L994,431.1914 L784,431.1914" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M994,431.1914 L994,441.1914 L1004,441.1914 L994,431.1914" fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="81.9165" x="790" y="448.7598">Handler rule:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="190.417" x="790" y="464.0703">- orgId comes ONLY from JWT</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="199.5703" x="790" y="479.3809">- NEVER trusts orgId from body</text><g class="message" data-participant-1="H" data-participant-2="REPO"><polygon fill="#181818" points="1026.6519,509.4336,1036.6519,513.4336,1026.6519,517.4336,1030.6519,513.4336" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="779.2617" x2="1032.6519" y1="513.4336" y2="513.4336"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="235.3901" x="786.2617" y="508.6914">repo.create({...data, orgId: ORG_JWT})</text></g><g class="message" data-participant-1="REPO" data-participant-2="DB"><polygon fill="#181818" points="1287.3687,538.7441,1297.3687,542.7441,1287.3687,546.7441,1291.3687,542.7441" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="1038.6519" x2="1293.3687" y1="542.7441" y2="542.7441"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="236.7168" x="1045.6519" y="538.002">INSERT market with orgId = ORG_JWT</text></g><g class="message" data-participant-1="DB" data-participant-2="REPO"><polygon fill="#181818" points="1049.6519,568.0547,1039.6519,572.0547,1049.6519,576.0547,1045.6519,572.0547" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="1043.6519" x2="1298.3687" y1="572.0547" y2="572.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="164.709" x="1055.6519" y="567.3125">OK (RLS ensures isolation)</text></g><g class="message" data-participant-1="REPO" data-participant-2="H"><polygon fill="#181818" points="790.2617,597.3652,780.2617,601.3652,790.2617,605.3652,786.2617,601.3652" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="784.2617" x2="1037.6519" y1="601.3652" y2="601.3652"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="43.3989" x="796.2617" y="596.623">Market</text></g><g class="message" data-participant-1="H" data-participant-2="GW"><polygon fill="#181818" points="242.9307,626.6758,232.9307,630.6758,242.9307,634.6758,238.9307,630.6758" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="236.9307" x2="778.2617" y1="630.6758" y2="630.6758"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="72.1729" x="248.9307" y="625.9336">201 Market</text></g><g class="message" data-participant-1="GW" data-participant-2="Client"><polygon fill="#181818" points="38.7524,655.9863,28.7524,659.9863,38.7524,663.9863,34.7524,659.9863" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2,2;" x1="32.7524" x2="230.9307" y1="659.9863" y2="659.9863"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="72.1729" x="44.7524" y="655.2441">201 Market</text></g><!--SRC=[PLDRRjim4FpdAHR-A6B0iLgZNmPImA_6Rlq8xC110mC5BQqJ8ZIfa5GInV0DUeLUhYVfafIQHp_5dTsTdHavuIJ22jF281YyBz0ws4dzs8M6DZUJ37P6x-7RrMKB53wWYTzRdPKDndZgj8615AWSoxbn8XKvLmuQlOi9d7E7Zxo41BvowyIkR02tS7xr3bcuMvY9B9C4DXWmlTbRp58N3c7DfSWuRToeaskT9OiS5UrfXfPrR_gsPymLZVJOFJTtwAfl6-7ZTmimrrRGw9BmkJREWbQoZDZbw6B1Q37VSelG6FO9ivok2051eeWQzXcBIi3f5xeIkd2nM5r2GXYR70Boc4GkTgFysTg8P-w4Lbte8zrklCuRrITnkt2mvNwhPGlk2-rma9OjQBVRHqQJQNvlHlD7JywG1V01o1ZIrxSpgjJrTNoruaPnHmPlrE0Mqpl0fpnHsrt2Ywn-ClYWqy05fB2kcXAk64WkzXOEXKKpoLhnvhF5ylndI8NH4ksHLRp81dyuDwIK3may2hBtUc2GmZ0BnqzKNZYIyC_lNt4MAEs0ImeTPY1Kw6ioFwccK3bFPMy3TS7dJiVhZyPeK-yU4p9zjUZ4aAl_yVKJcenMKjx5pQq3lQCqLEa0KqZiijEAMAhtQ64nd_xuznjGRJvQZvRWJ65zJ5v-4i-ReGht86DZpybdXsXv9kt8xUH0DdeI5RCkLDIEJHRGr3NiKyzalXejBo4c9keObvtL7OnmfozB5jyXv1AL9RCj2AjbiBGUN6aKrV7yQdqx7p_LhrvAUgwI_Bhq5m00]--></g></svg>